#!/usr/bin/env  cbqn

To â† {ğ•¨>ğ•©? âŒ½ğ•©â†“ğ•¨âˆ¾Ëœâ†•ğ•¨ ; ğ•¨â†“ğ•©âˆ¾Ëœâ†•ğ•©}
F â† â¥Šâ‰2 Â¯1â†“Ë˜{{ âŸ¨a,bâŸ©â€¿âŸ¨c,dâŸ© â† ğ•© â‹„ {a=c? {aâ€¿ğ•©}Â¨ b To d; b=d? {ğ•©â€¿b}Â¨ a To c}â€¿âŸ¨âŸ© }Ë˜2â†•ğ•©}

inputâ† âŒ½Â¨âˆ¾âˆ¾Â´Fâˆ˜â€¢BQNâˆ˜âˆ¾âˆ˜{"âŸ¨âŸ¨"âˆ¾ğ•©âˆ¾"âŸ©âŸ©"}Â¨{(âŠ‘"->"âŠğ•©)âŠ‘"âŸ©,"â€¿'âŸ¨'â€¿ğ•©}Â¨Â¨â€¢Flines "input.txt"
âŸ¨maxCol,minColâŸ©â€¿âŸ¨maxRow,minRowâŸ© â† <âˆ˜(âŒˆÂ´âˆ¾âŒŠÂ´)Ë˜â‰>input
Disp â† (2Ã—maxRow-minRow)âŠ¸+âˆ˜(maxRowâŠ¸-)âŒ¾(1âŠ¸âŠ‘) #Displacement
source â† Disp âŸ¨0,500âŸ©
input â†© DispÂ¨input

gridâ†(3+maxCol)â€¿(5Ã—maxRow-minRow)â¥Š'.'
{ gridâ†© '#'âŒ¾(ğ•©âŠ¸âŠ‘)grid â‹„ @}Â¨input

Viewâ†âŸ¨0â€¿1,Â¯1â€¿1,Â¯1â€¿0,Â¯1â€¿Â¯1,0â€¿Â¯1âŸ© -ËœâŒœ<

SimStep â† { 
  lâ€¿dlâ€¿dâ€¿drâ€¿r â† {ğ•©âŠ‘âŠ'!'grid}Â¨liâ€¿dliâ€¿diâ€¿driâ€¿ri â† View org â† ğ•©
  {d='.'? di;
   d='#'? {dr='.'?dri; dl='.'?dli; org};
   d='!'? @
  }
} 
Sim â† {
  step â† SimStep org â† ğ•©
  { stepâ‰¡@? @;
    stepâ‰¡org? org;
    Sim step
}}

AddSand â† {
  step â† Sim ğ•©
  {stepâ‰¡@? @;
   gridâ†© '#'âŒ¾(stepâŠ¸âŠ‘)grid
  }
}

sands â† Â¯1
{ğ•© â‹„ sands +â†© 1 â‹„ AddSand source}â€¢_while_{@â‰¢ğ•©} grid
â€¢Show sands
gridâ†©(3+maxCol)â€¿âˆ˜â¥Šâˆ¾Â´'#'Â¨âŒ¾(Â¯1âŠ¸âŠ‘)<Ë˜grid
{ğ•© â‹„ sands +â†© 1 â‹„ AddSand source}â€¢_while_{('#'â‰ sourceâŠ‘ğ•©)âˆ§@â‰¢ğ•©} grid
â€¢Show sands
â€¢Show grid
